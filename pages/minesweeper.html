<!DOCTYPE html>
<html>
	<head>
		<title>Minesweeper</title>
		<meta name="viewport"content="width=device-width,initial-scale=1">
		<style>
			body{
				margin:0 0;
				font-family:Arial,sans-serif;
				overflow:hidden;
			}
			fieldset.wrap{width:fit-content}
			input.clrin{
				width:60px;
				text-shadow:0 0 1px #000;
			}
			td{text-align:right}
		</style>
	</head>
	<body>
		<div id=flexbox>
			<canvas id=cvs></canvas><br>
			<fieldset>
				<button onclick='init()'>restart</button>
				<div id=bombsLeftd></div>
				<div style='display:flex'>
					<fieldset class=wrap>
						<div id=gridArea></div>
						Grid Size<br>
						<input id=gdi type=range min=12 max=60 step=2 value=20 oninput='setVal("grid",parseFloat(this.value))'/><span id=gridSized>20</span><br>
						Grouped Bomb %<br>
						<input id=bnbi type=range min=0 max=.9 step=.05 value=.2 oninput='setVal("bnby",parseFloat(this.value))'/><span id=bombsNearbyd>20%</span><br>
						Bomb Population<br>
						<input id=bpci type=range min=.05 max=.6 step=.025 value=.15 oninput='setVal("bpc",parseFloat(this.value))'/><span id=bombPopulationd>30</span><br>
						<button onclick='reset()'>default</button>
					</fieldset>
					<fieldset class=wrap id=clrs>
						<table>
							<tr>
								<td>BG1</td>
								<td><input class=clrin id=bgColor1In oninput='this.style.color=this.value;setVal("bgc1",this.style.color);'/></td>
								<td>BG2</td>
								<td><input class=clrin id=bgColor2In oninput='this.style.color=this.value;setVal("bgc2",this.style.color);'/></td>
							</tr>
							<tr>
								<td>1</td><td><input class=clrin id=tile1In oninput='this.style.color=this.value;setVal("tile",this.style.color,"1");'/></td><td>2</td><td><input class=clrin id=tile2In oninput='this.style.color=this.value;setVal("tile",this.style.color,"2");'/></td>
							</tr>
							<tr>
								<td>3</td><td><input class=clrin id=tile3In oninput='this.style.color=this.value;setVal("tile",this.style.color,"3");'/></td><td>4</td><td><input class=clrin id=tile4In oninput='this.style.color=this.value;setVal("tile",this.style.color,"4");'/></td>
							</tr>
							<tr>
								<td>5</td><td><input class=clrin id=tile5In oninput='this.style.color=this.value;setVal("tile",this.style.color,"5");'/></td><td>6</td><td><input class=clrin id=tile6In oninput='this.style.color=this.value;setVal("tile",this.style.color,"6");'/></td>
							</tr>
							<tr>
								<td>7</td><td><input class=clrin id=tile7In oninput='this.style.color=this.value;setVal("tile",this.style.color,"7");'/></td><td>8</td><td><input class=clrin id=tile8In oninput='this.style.color=this.value;setVal("tile",this.style.color,"8");'/></td>
							</tr>
						</table>
						<button onclick='initMap()'>default</button>
					</fieldset>
				</div>
			</fieldset>
		</div>
		<script>
const ctx=cvs.getContext("2d");
const keybinds={
	multi:"",
	flag:"",
	dig:""
}
const backgroundColors={
	bg1:"#555",
	bg2:"#bbb"
}
const map={f:{sym:"f"},b:{sym:"b"},x:{txt:"red"}}
const gridSize={x:20,y:10};
const userMouse={x:0,y:0};
let firstPick=true;
let bpc=.15;
let bnb=.2;
let died=false;
let cells=[];
let actual=[];
let immune=[];
let diedTimeout;
let flagTimeout;
let flagDelay=150;
let flagDebounce=false;
function reset(){
	setVal("grid",20);
	setVal("bnby",.2);
	setVal("bpc",.15);
}
function initMap(){
	map["1"]={txt:tile1In.value=tile1In.style.color="#04f"};
	map["2"]={txt:tile2In.value=tile2In.style.color="#194"};
	map["3"]={txt:tile3In.value=tile3In.style.color="#f01"};
	map["4"]={txt:tile4In.value=tile4In.style.color="#909"};
	map["5"]={txt:tile5In.value=tile5In.style.color="#fd0"};
	map["6"]={txt:tile6In.value=tile6In.style.color="#0af"};
	map["7"]={txt:tile7In.value=tile7In.style.color="#777"};
	map["8"]={txt:tile8In.value=tile8In.style.color="#eee"};
	bgColor1In.value=bgColor1In.style.color=backgroundColors.bg1="#555";
	bgColor2In.value=bgColor2In.style.color=backgroundColors.bg2="#bbb";
}
function setVal(n,v,i,t){
	switch(n){
		case"grid":
			gridSize.x=gdi.value=v;
			gridSize.y=v/2;
			gridSized.innerText=v;
			bombPopulationd.innerText=bombDensity(bpc);
			init();
		break;
		case"bnby":
			bombsNearbyd.innerText=(v*100).toFixed()+"%";
			bnb=bnbi.value=v;
			init();
		break;
		case"bpc":
			bombPopulationd.innerText=bombDensity(v).toFixed();
			bpc=bpci.value=v;
			init();
		break;
		case"bgc1":backgroundColors.bg1=v;break;
		case"bgc2":backgroundColors.bg2=v;break;
		case"tile":map[i].txt=v;break;
	}
}
function init(){
	clearTimeout(diedTimeout);
	firstPick=true;died=false;
	cells=[];actual=[];
	for(let i=0,j;i<gridSize.y;i++)for(cells[i]=[],actual[i]=[],j=0;j<gridSize.x;j++){
		cells[i][j]="";
		actual[i][j]="";
	}
}
function getPS(){
	let w=cvs.width,h=cvs.height,{x,y}=gridSize;
	return(w<h?w/x-.125:h/y-.15);
}
function bombDensity(p){
	return gridSize.x*gridSize.y*p|0;
}
async function auto(ms,f){
	if(firstPick){
		firstPick=false;
		generateBombs();
		initNumberedCells();
	}
	for(let i=0,j;i<gridSize.y;i++)for(j=0;j<gridSize.x;j++){
		if(cells[i][j]!="")continue;
		if(actual[i][j]!="b")reveal(j,i);
		else if(f)placeFlag(j,i);
		flagDebounce=false;
		if(Math.random()>.8)await new Promise(r=>setTimeout(r,ms));
	}
}
function symNearby(x,y,s){
	let n=false;
	for(let i=(y-1<0)?y:y-1;i<=(y+1>=gridSize.y?y:y+1);i++)for(let j=(x-1<0?x:x-1);j<=(x+1>=gridSize.x?x:x+1);j++)if(actual[i][j]==s)n=true;
	return n;
}
function checkIfWon(){
	let won=true;
	for(let i=0,j;i<gridSize.y;i++)for(j=0;j<gridSize.x;j++){
		if(cells[i][j]=="f"&&actual[i][j]!="b")won=false;
		else if(cells[i][j]==""&&actual[i][j]!="b")won=false;
	}
	return won;
}
function generateBombs(){
	const total=bombDensity(bpc);
	let count=0,tries=0;
	while(count<total&&count<gridSize.x*gridSize.y-9){
		let x=Math.random()*gridSize.x|0;
		let y=Math.random()*gridSize.y|0;
		let spwnchn=symNearby(x,y,"b")?1-bnb:bnb;
		if(immune.indexOf(x+","+y)<0&&actual[y][x]!="b"&&Math.random()>spwnchn){
			actual[y][x]="b";
			count++;
		}else tries++;
		if(tries>1e6&&count>0)break;
	}
}
function initNumberedCells(){
	for(let i=0,j;i<gridSize.y;i++)for(j=0;j<gridSize.x;j++){
		if(actual[i][j]===""){
			let bombCount=0;
			for(let y=(i-1<0)?i:i-1;y<=(i+1>=gridSize.y?i:i+1);y++)for(let x=(j-1<0?j:j-1);x<=(j+1>=gridSize.x?j:j+1);x++){
				if(actual[y][x]=="b")bombCount++;
			}
			actual[i][j]=bombCount+"";
		}
	}
}
function reveal(x,y){
	if(flagDebounce)return;
	cells[y][x]=actual[y][x];
	if(cells[y][x]=="b"){
		died=true;
		setTimeout(()=>{
			for(let i=0,j;i<gridSize.y;i++)for(j=0;j<gridSize.x;j++)if(actual[i][j]!="b"&&cells[i][j]=="f")cells[i][j]="x";
		},5);
		clearTimeout(flagTimeout);
		diedTimeout=setTimeout(init,1500);
	}
	if(checkIfWon()&&!firstPick){
		firstPick=true;
		setTimeout(init,500);
	}
}
function dig(x,y){
	if(cells[y][x]=="f")return;
	if(symNearby(x,y,"b"))reveal(x,y);
	else digAdjacent(x,y);
}
function digAdjacent(x,y,g){
	if(cells[y][x]=="f")return;
	let c=actual[y][x];
	for(let i=(y-1<0)?y:y-1;i<=(y+1>=gridSize.y?y:y+1);i++)for(let j=(x-1<0?x:x-1);j<=(x+1>=gridSize.x?x:x+1);j++)if((actual[i][j]!="b"||g)&&cells[i][j]!="f")reveal(j,i);
}
function multiDig(x,y){
	let c=actual[y][x];
	if(isNaN(c)||c==="0")return;
	let flags=0;
	for(let i=(y-1<0)?y:y-1;i<=(y+1>=gridSize.y?y:y+1);i++)for(let j=(x-1<0?x:x-1);j<=(x+1>=gridSize.x?x:x+1);j++)if(cells[i][j]=="f")flags++;
	if(flags+""==c)digAdjacent(x,y,1);
}
function placeFlag(x,y){
	flagDebounce=true;
	if(cells[y][x]=="f")cells[y][x]="";
	else if(cells[y][x]=="")cells[y][x]="f";
	setTimeout(()=>flagDebounce=false,200);
}
requestAnimationFrame(function update(){
	let p=getPS();
	ctx.clearRect(0,0,cvs.width,cvs.width);
	let flagCount=0,bombCount=0;
	for(let i=0,j;i<gridSize.y;i++)for(j=0;j<gridSize.x;j++){
		let cell=cells[i][j],st=map[cell];
		if(cell=="f"&&actual[i][j]=="0")cells[i][j]="0";
		if(cell=="f")flagCount++;
		if(actual[i][j]=="b")bombCount++;
		if(cell=="0")digAdjacent(j,i);
		ctx.fillStyle=cell===""||cell=="f"||cell=="x"?backgroundColors.bg1:backgroundColors.bg2;
		ctx.fillRect(p*j,p*i,p,p);
		if(st?.txt){
			ctx.font=p+"px monospace";
			ctx.fillStyle=st.txt;
			ctx.fillText(cell,p*j+p/5,p*i+p/1.17);
		}else if(st?.sym){
			if(st.sym=="f"){
				ctx.beginPath();
				ctx.fillStyle="red";
				ctx.moveTo(p*j+p/3,p*i+p/12);
				ctx.lineTo(p*j+p*8/9,p*i+p*33/80);
				ctx.lineTo(p*j+p/3,p*i+p*97/136);
				ctx.rect(p*j+p/3,p*i+p/12,-p/12,p*33/40);
				ctx.fill();
			}else{
				ctx.font=p*.75+"px monospace";
				ctx.fillText(String.fromCharCode(55357,56485),p*j,p*i+p/1.35);
			}
		}
	}
	bombsLeftd.innerText="Flags: "+(bombCount-flagCount);
	gridArea.innerText="Grid Area: "+gridSize.x*gridSize.y
	requestAnimationFrame(update);
});
window.onresize=function(){
	let w=(Math.min(screen.width,screen.height)*.995)|0;
	let o=window.innerWidth<window.innerHeight;
	let r=gridSize.x/gridSize.y;
	flexbox.style.display=o?"inline-block":"flex";
	cvs.width=o?w:w*r*.8;
	cvs.height=o?w/r:w*.8;
}
window.onresize();
cvs.addEventListener("click",e=>{
	if(died)return;
	let p=getPS();
	userMouse.x=(e.pageX-cvs.offsetLeft)/p|0;
	userMouse.y=(e.pageY-cvs.offsetTop)/p|0;
	let x=(e.pageX-cvs.offsetLeft)/p|0,y=(e.pageY-cvs.offsetTop)/p|0;
	if(firstPick){
		firstPick=false;
		for(let i=y-1;i<y+2;i++)for(let j=x-1;j<x+2;j++)immune.push(j+","+i);
		generateBombs();
		initNumberedCells();
		digAdjacent(x,y);
	}else{
		dig(x,y);
		multiDig(x,y);
	}
});
["mouseup","touchend","touchcancel"].forEach(v=>cvs.addEventListener(v,e=>clearTimeout(flagTimeout)));
["touchmove","mousemove"].forEach((v,j)=>cvs.addEventListener(v,e=>{
	let p=getPS(),t=e.targetTouches&&e.targetTouches.item(0);
	let x=((j?e:t).pageX-cvs.offsetLeft)/p|0,y=((j?e:t).pageY-cvs.offsetTop)/p|0;
	if(x!=userMouse.x||y!=userMouse.y)clearTimeout(flagTimeout);
	if(died)return;
	userMouse.x=x;
	userMouse.y=y;
}));
cvs.addEventListener("mousedown",e=>{
	flagTimeout=setTimeout(()=>placeFlag(userMouse.x,userMouse.y),flagDelay);
});
cvs.addEventListener("touchstart",e=>{
	if(died)return;
	let p=getPS(),t=e.targetTouches.length?e.targetTouches.item(0):e.touches.item(0);
	userMouse.x=(t.pageX-cvs.offsetLeft)/p|0;
	userMouse.y=(t.pageY-cvs.offsetTop)/p|0;
	flagTimeout=setTimeout(()=>{
		placeFlag(userMouse.x,userMouse.y)
	},flagDelay);
});
init();initMap();
//add desktop counterparts later
		</script>
	</body>
</html>