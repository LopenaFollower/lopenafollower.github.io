<!DOCTYPE html>
<html>
	<head>
		<title>Sudoku</title>
		<meta name="viewport"content="width=device-width,initial-scale=1">
		<meta name="color-scheme"content="light dark">
		<style>
			body{margin:0;padding:0}
			@media(orientation:landscape){
				#cvs{
					max-height:800px;
					width:auto;
				}
				fieldset{
					max-width:450px;
				}
			}
			@media(orientation:portrait){
				#cvs{
					width:98%;
					max-width:800px;
				}
			}
			table{
				border-collapse:collapse;
				table-layout:fixed;
				border-color:#eee;
				width:100%;
			}
			td{
				text-align:center;
				font-size:150%;
				width:calc(100%/9);
				height:40px;
			}
			span,td{
				user-select:none;
			}
		</style>
	</head>
	<body>
		<div id=flexbox>
			<canvas id=cvs></canvas>
			<fieldset>
				<pre id=timedisp></pre>
				<input type=checkbox id=noting><span onclick="noting.click()">Note</span>
				<table border=1>
					<tr>
						<td onclick='place(0)'>X</td>
						<td onclick='place(1)'>1</td>
						<td onclick='place(2)'>2</td>
						<td onclick='place(3)'>3</td>
						<td onclick='place(4)'>4</td>
						<td onclick='place(5)'>5</td>
						<td onclick='place(6)'>6</td>
						<td onclick='place(7)'>7</td>
						<td onclick='place(8)'>8</td>
						<td onclick='place(9)'>9</td>
					</tr>
				</table>
				<sup style="display:none;opacity:.5">or use 0-9 keys</sup>
				<br><button onclick='newGame()'>New Game</button>
				<br><select onchange="theme=this.value">
					<option>light</option>
					<option selected>dark</option>
					<option>lsd</option>
					<option>epilepsy</option>
				</select>
			</fieldset>
		</div>
		<script>
let lt=localStorage.lt=1/0;
const ctx=cvs.getContext("2d"),{random,min:minVal,max:maxVal,round,ceil}=Math;
let isMobile=(function(){
	let e,o=/(android|bb\d+|meego).+mobile|avantgo|bada\/|bla(ckberry|zer)|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series[46]0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino|android|ipad|playbook|silk/i;
	return(e=navigator.userAgent)&&e.headers&&"string"==typeof e.headers["user-agent"]&&(e=e.headers["user-agent"]),"string"==typeof e&&(!!(navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&/MacIntel/.test(navigator.platform))||o.test(e));
})();
window.onresize=function(){
	cvs.width=cvs.height=minVal(minVal(window.innerWidth,window.innerHeight),800);
}
window.onresize();
function isNum(n){
	return(typeof n=="number"&&n-n===0)||(typeof n=="string"&&Number.isFinite(+n)&&n.trim()!="");
}
function RGB(s=1){
	let c=[255,0,0],i=0,j=1,d=s,l=setInterval(()=>(d<0?c[i]>-1-d:c[j]<255-d)?c[d<0?i:j]+=d:s+(d=-d)&&(i=++i%3,j=++j%3));
	this.getDecimal=function(r=0,g=1,b=2){
		return(1<<24)|(c[r]<<16)|(c[g]<<8)|c[b];
	}
	this.getHex=function(pattern="rgb"){
		return"#"+this.getDecimal(...[...pattern].map(e=>({r:0,g:1,b:2}[e]))).toString(16).slice(1);
	}
}
const rgb=new RGB(3);
var theme="dark";
let all=(()=>{
	let a=["r","g","b"],t=new Set();
	for(let i of a)for(let j of a)for(let k of a)t.add(i+j+k);
	return[...t].sort();
})();
const themes={
	light:{
		grid1x1:"#777",
		grid3x3:"#111",
		bg:"#fff",
		border:"#346",
		selected:"#bcbcbc",
		adjacent:"#dadada",
		num_fixed:"#346",
		num_correct:"#35a",
		num_wrong:"#f00",
		text:"#000",
		note:"#666"
	},
	dark:{
		grid1x1:"#555",
		grid3x3:"#aaa",
		bg:"#1a1a1a",
		border:"#8fd",
		selected:"#4a4a4a",
		adjacent:"#323232",
		num_fixed:"#07f",
		num_correct:"#3a7",
		num_wrong:"#f33",
		text:"#ddd",
		note:"#5a7baa"
	},
	lsd:{},epilepsy:{l:[...all]}
}
let r=c=>rgb.getHex(c);
Object.defineProperties(themes.lsd,{
	grid1x1:{get(){return r(all[21])}},
	grid3x3:{get(){return r(all[7])}},
	bg:{get(){return r(all[19])}},
	border:{get(){return r(all[6])}},
	selected:{get(){return r(all[13])}},
	adjacent:{get(){return r(all[0])}},
	num_fixed:{get(){return r(all[15])}},
	num_correct:{get(){return r(all[5])}},
	num_wrong:{get(){return r(all[11])}},
	text:{get(){return r(all[26])}},
	note:{get(){return r(all[17])}}
});
Object.defineProperties(themes.epilepsy,{
	grid1x1:{get(){return r(this.l[0])}},
	grid3x3:{get(){return r(this.l[1])}},
	bg:{get(){return r(this.l[2])}},
	border:{get(){return r(this.l[3])}},
	selected:{get(){return r(this.l[4])}},
	adjacent:{get(){return r(this.l[5])}},
	num_fixed:{get(){return r(this.l[6])}},
	num_correct:{get(){return r(this.l[7])}},
	num_wrong:{get(){return r(this.l[8])}},
	text:{get(){return r(this.l[9])}},
	note:{get(){return r(this.l[10])}},
	ref:{get(){this.n=++this.n%3;!this.n&&(this.l=this.l.sort(_=>random()-.5))}}
});
const{place,newGame}=(function(){
	const d3=n=>n/3|0;
	const shuf=a=>{
		for(let i=a.length-1;i>0;i--){
			let j=random()*(i+1)|0;
			[a[i],a[j]]=[a[j],a[i]];
		}
		return a;
	};
	function sleep(ms){
		return new Promise(r=>setTimeout(r,ms));
	}
	class Sudoku{
		#key=[];
		mat=Array(9).fill().map(e=>Array(9));
		notes=Array(9).fill().map(e=>Array(9).fill().map(e=>[]));
		#mistakes=0;
		constructor(K){
			this.K=K;
			this.e=random()/2;
		}
		generateFull(){
			const pat=(r,c)=>r*3+d3(r)+c;
			let rs=[0,1,2,3,4,5,6,7,8],cs=[...rs],ns=shuf([1,2,3,4,5,6,7,8,9]),rB=shuf([0,1,2]),cS=shuf([0,1,2]);
			for(let b=0;b<3;b++)rs.splice(b*3,3,...shuf(rs.slice(b*3,3+b*3)));
			for(let c=0;c<3;c++)cs.splice(c*3,3,...shuf(cs.slice(c*3,3+c*3)));
			rs=rB.flatMap(b=>rs.slice(b*3,3+b*3));
			cs=cS.flatMap(s=>cs.slice(s*3,3+s*3));
			for(let x=0;x<9;x++)for(let y=0;y<9;y++)this.mat[x][y]=ns[pat(rs[x],cs[y])%9];
		}
		async generateUnique(){
			const handler=e=>{
				const{o,mat,M}=e.data;
				this.mat=o?Array(9).fill().map(e=>Array(9)):mat;
				if(o){
					atmp++;
					this.generateFull();
					this.#key=this.getCopy();
					worker.postMessage({mat:this.mat,K:this.K});
				}else{
					console.log(...M);
					startTime=Date.now();
					worker.terminate();
					worker=null;
				}
			}
			worker=new Worker(URL.createObjectURL(new Blob([`
			const{random}=Math,d3=n=>n/3|0;
			const shuf=a=>{
				for(let i=a.length-1;i>0;i--){
					let j=random()*(i+1)|0;
					[a[i],a[j]]=[a[j],a[i]];
				}
				return a;
			};
			class Node{
				constructor(){
					this.L=this.R=this.U=this.D=this.C=this;
					this.r=-1;
					this.z=0;
				}
			}
			class DLX{
				constructor(mat,rI,cC){
					this.H=new Node();
					this.H.L=this.H.R=this.H;
					this.cs=[];
					let p=this.H;
					for(let i=0;i<cC;i++){
						const c=new Node();
						p.R=this.cs[i]=c.U=c.D=c;
						[c.z,c.L,p]=[0,p,c];
					}
					[p.R,this.H.L,this.rI]=[this.H,p,rI];
					for(let r=0,f;r<mat.length;r++,f=null)for(let i of mat[r]){
						const c=this.cs[i],n=new Node();
						[n.r,n.C,n.D,n.U]=[r,c,c,c.U];
						[c.U.D,c.U]=[n,n];
						c.z++;
						if(f){
							[n.R,n.L]=[f,f.L];
							f.L.R=f.L=n;
						}else f=n.L=n.R=n;
					}
				}
				cover(c){
					[c.R.L,c.L.R]=[c.L,c.R];
					for(let i=c.D;i!==c;i=i.D)for(let j=i.R;j!==i;j.C.z--,j=j.R)[j.D.U,j.U.D]=[j.U,j.D];
				}
				uncover(c){
					for(let i=c.U;i!==c;i=i.U)for(let j=i.L;j!==i;j.C.z++,j=j.L)j.D.U=j.U.D=j;
					c.R.L=c.L.R=c;
				}
				search(lim,sR,cb){
					if(this.H.R===this.H){
						cb(sR.slice());
						return true;
					}
					let c=this.H.R;
					for(let j=c.R;j!==this.H;j=j.R)if(j.z<c.z)c=j;
					this.cover(c);
					for(let r=c.D;r!==c;r=r.D){
						sR.push(r.r);
						for(let j=r.R;j!==r;j=j.R)this.cover(j.C);
						if(this.search(lim,sR,cb))if(this.stop)return true;
						sR.pop();
						for(let j=r.L;j!==r;j=j.L)this.uncover(j.C);
					}
					this.uncover(c);
				}
				solutions(lim=1,cb=_=>{}){
					this.stop=false;
					let f=0;
					const ts=this;
					this.search(lim,[],r=>{
						cb(r.slice());
						if(++f>=lim)ts.stop=true;
					});
					return f;
				}
			}
			function buildRow(r,c,d){
				return[9*r+c,81+9*r+d,162+9*c+d,243+27*d3(r)+9*d3(c)+d];
			}
			function buildCover(b){
				const rs=[],rI=[];
				for(let r=0;r<9;r++)for(let c=0;c<9;c++)if(b[r][c]){
					const d=b[r][c]-1;
					rs.push(buildRow(r,c,d));
					rI.push([r,c,d]);
				}else for(let d=0;d<9;d++){
					rs.push(buildRow(r,c,d));
					rI.push([r,c,d]);
				}
				return{rs,rI};
			}
			function sv(b){
				const{rs,rI}=buildCover(b);
				return new DLX(rs,rI,324).solutions(2);
			}
			onmessage=e=>{
				const{mat,K}=e.data,cs=[];
				for(let i=0;i<81;i++)cs[i]=i;
				let r=0;
				shuf(cs);
				for(let i=0;i<81&&r<K;i++){
					const x=cs[i]/9|0,y=cs[i]%9,t=mat[x][y];
					mat[x][y]=0;
					const c=mat.map(m=>m.slice());
					if(sv(c)-1)mat[x][y]=t;else r++;
				}
				if(K-r)postMessage({o:true});
				else postMessage({o:null,mat,M:[r,mat.flat().filter(e=>e<1).length]});
			}
			`],{type:"text/javascript"})));
			worker.onmessage=handler;
			worker.onerror=e=>{
				console.error(e);
			}
			worker.postMessage({mat:this.mat,K:this.K});
			while(worker)await sleep(25);
		}
		getCopy(){
			return this.mat.map(m=>m.slice());
		}
		correct(n,x,y,m){
			let b=n==this.#key[y][x];
			if(!b&&m&&+n)this.#mistakes++;
			return b;
		}
		getMistakes(){
			return this.#mistakes;
		}
		check(a){
			return JSON.stringify(a)==JSON.stringify(this.#key);
		}
		countMissing(a){
			let c=Array(9).fill(0);
			for(let i=0;i<9;i++)for(let j=0;j<9;j++)if(a[i][j]-this.#key[i][j])c[this.#key[i][j]-1]++;
			return c;
		}
		RO(){
			return(this.t=="lsd"?10:this.t=="epilepsy"?20:1)*random()*this.e-this.e/2;
		}
		togNote(x,y,n){
			let i=this.notes[y][x].indexOf(n);
			if(i+1)this.notes[y][x].splice(i,1);
			else this.notes[y][x].push(n);
		}
		updNotes(px,py,n){
			let rx=d3(px),ry=d3(py);
			const rem=(x,y,n)=>{
				let i=this.notes[y][x].indexOf(n);
				if(i+1)this.notes[y][x].splice(i,1);
			}
			for(let x=3*rx;x-3*rx<3;x++)for(let y=3*ry;y-3*ry<3;y++)rem(x,y,n);
			for(let i=0;i<9;i++){
				rem(px,py,i);
				rem(px,i,n);
				rem(i,py,n);
			}
		}
	}
	let sudoku,current,selected,won,startTime,endTime,generating,worker,atmp;
	newGame(true);
	function getPS(){
		return 149*cvs.width/1350;
	}
	async function newGame(f){
		if(generating){
			if(confirm("Still generating, cancel?")){
				generating=false;
				worker.terminate();
				worker=null;
				newGame();
			}
			return;
		}
		let dif=f?57:minVal(62,maxVal(1,Number(prompt("Missing Count(1-62)",58).replaceAll(/\D/g,""))));
		sudoku=new Sudoku(dif);
		noting.checked=false;
		won=atmp=0;
		generating=true;
		selected=null;
		current=Array(9).fill().map(e=>Array(9));
		await sudoku.generateUnique();
		current=sudoku.getCopy();
		generating=false;
	}
	function fill(c="#fff"){
		ctx.fillStyle=c;
	}
	function displayBoard(){
		const s=cvs.width,gr=current;
		let m=s/150,p=getPS();
		fill(themes[theme].grid1x1);
		ctx.fillRect(0,0,s,s);
		for(let i=0;i<4;i++){
			if(i&&i<3)fill(themes[theme].grid3x3);else fill(themes[theme].border);
			ctx.fillRect(0,p*3*i,s,m);
			ctx.fillRect(p*3*i,0,m,s);
		}
		for(let y=0;y<9;y++)for(let x=0;x<9;x++){
			fill(themes[theme].bg);
			if(selected){
				let[n,i,j]=selected;
				if(x==i||y==j||d3(x)==d3(i)&&d3(y)==d3(j))fill(themes[theme].adjacent);
				if(!n&&x==i&&y==j||(n||!n&&gr[y][x])&&gr[y][x]==gr[j][i])fill(themes[theme].selected);
			}
			ctx.fillRect(m+x*p,m+y*p,p-m,p-m);
			if(gr[y][x]){
				if(info(x,y)[0]==gr[y][x])fill(themes[theme].num_fixed);else{
					if(sudoku.correct(gr[y][x],x,y,0))
					fill(themes[theme].num_correct);else fill(themes[theme].num_wrong);
				}
				ctx.font=4*p/5+"px sans-serif";
				ctx.fillText(gr[y][x],x*p+p/3.3-sudoku.RO(),y*p+14*p/17-sudoku.RO());
			}else{
				ctx.font=p/4.8+"px sans-serif";
				fill(themes[theme].note);
				sudoku.notes[y][x].forEach(e=>ctx.fillText(e,(x+165/817)*p-sudoku.RO()+((e-1)%3)*p/3.8,(y+137/414)*p-sudoku.RO()+d3(e-1)*p/3.6));
			}
		}
	}
	function getTime(ms,d){
		let s=ms/1e3|0,m=s/60|0;s-=m*60;
		return m+":"+(s+"").padStart(2,0)+(d?"."+ms%1000:"");
	}
	function displayStat(){
		const s=cvs.width;
		let m=s/150,fs=s/12;
		ctx.font=fs+"px sans-serif";
		fill(themes[theme].bg);
		ctx.fillRect(0,0,s,s);
		fill(themes[theme].text);
		ctx.fillText("Mistakes: "+sudoku.getMistakes(),m,m+fs);
		ctx.fillText("Difficulty: "+round(sudoku.K/.62)+" / 100",m,m+fs*2);
		ctx.fillText("Time: "+getTime(endTime-startTime),m,m+fs*3);
	}
	function place(n){
		if(!selected)return;
		let[p,x,y]=selected;
		if(p||won||document.querySelectorAll("td")[n].style.opacity=="0")return;
		if(n==current[y][x]&&!noting.checked)return current[y][x]="";
		if(noting.checked)return sudoku.togNote(x,y,n);
		current[y][x]=n;
		sudoku.updNotes(x,y,n);
		sudoku.correct(n,x,y,1);
		if(sudoku.check(current)){
			endTime=Date.now();
			setTimeout(_=>won=true);
		}
	}
	function info(x,y){
		return[generating?0:sudoku.mat[y][x],x,y];
	}
	cvs.addEventListener("click",e=>{
		let p=getPS();
		selected=info((e.pageX-cvs.offsetLeft)/p|0,(e.pageY-cvs.offsetTop)/p|0);
	});
	requestAnimationFrame(function update(){
		requestAnimationFrame(update);
		sudoku.t=theme;
		timedisp.innerText=generating?`Generating Board (${atmp})`:getTime((won?endTime:Date.now())-startTime,1);
		flexbox.style.display=window.innerWidth<window.innerHeight?"inline-block":"flex";
		if(won)displayStat();else displayBoard();
		themes.epilepsy.ref;
		try{
			let ms=sudoku.countMissing(current);
			document.querySelectorAll("td").forEach((e,i)=>{
				if(i)e.style.opacity=(ms[i-1]/9)**.847985;
			});
		}catch(e){};
	});
	if(!isMobile){
		document.querySelector("sup").style.display="block";
		window.addEventListener("keydown",e=>{
			let k=e.key;
			if(isNum(k))place(+k);
			if(k=="Backspace")place(0);
			if(k=="n")noting.click();
		});
	}
	return{place,newGame};
})();
		</script>
	</body>
</html>